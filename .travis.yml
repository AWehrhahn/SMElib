language: cpp
compiler: gcc

python: "3.6"
cache:
  - pip

jobs:
  include:
  - os: linux
    dist: bionic
    addons:
      apt:
        packages:
        - g++
        - gfortran
        - make
        - python3.8
        - python3-venv
        - python3-pip
    before_deploy:
    - mkdir build
    - tar -czvf build/smelib.tar.gz lib share
  - os: osx
    addons:
      homebrew:
        update: true
        packages:
        - make
        - automake
        - libtool
        - python
    before_cache:
    - brew cleanup
  # - os: windows
  #   before_install:
  #   - |-
  #     case $TRAVIS_OS_NAME in
  #       windows)
  #         [[ ! -f C:/tools/msys64/msys2_shell.cmd ]] && rm -rf C:/tools/msys64
  #         choco uninstall -y mingw
  #         choco upgrade --no-progress -y msys2
  #         export msys2='cmd //C RefreshEnv.cmd '
  #         export msys2+='& set MSYS=winsymlinks:nativestrict '
  #         export msys2+='& C:\\tools\\msys64\\msys2_shell.cmd -defterm -no-start'
  #         export mingw64="$msys2 -mingw64 -full-path -here -c \$\* --"
  #         export msys2+=" -msys2 -c \$\* --"
  #         $msys2 pacman --sync --noconfirm --needed \
  #                 autoconf \
  #                 automake \
  #                 libtool \
  #                 mingw-w64-x86_64-libtool \
  #                 mingw-w64-x86_64-toolchain \
  #                 mingw-264-gcc
  #         ## Install more MSYS2 packages from https://packages.msys2.org/base here
  #         taskkill //IM gpg-agent.exe //F  # https://travis-ci.community/t/4967
  #         export PATH=/C/tools/msys64/mingw64/bin:$PATH
  #         export MAKE=mingw32-make  # so that Autotools can find it
  #         ;;
  #     esac
  #   before_cache:
  #   - |-
  #     case $TRAVIS_OS_NAME in
  #       windows)
  #         # https://unix.stackexchange.com/a/137322/107554
  #         $msys2 pacman --sync --clean --noconfirm
  #         ;;
  #     esac
  #   cache:
  #     directories:
  #     - "$HOME/AppData/Local/Temp/chocolatey"
  #     - "/C/tools/msys64"
  #   install:
  #   - $msys2 mkdir m4
  #   - $msys2 ./bootstrap
  #   script:
  #   # - $msys2 ./configure --prefix=$PWD
  #   - $msys2 make install
  #   - $msys2 tar -czvf smelib.tar.gz lib

install:
- ./bootstrap
- ./configure --prefix=$PWD
- make install

before_script:
- source ~/.bashrc
- pip3 install --upgrade pip
- pip3 install -r test/requirements.txt

script:
- python3 -m pytest

deploy:
  provider: releases
  skip_cleanup: true
  overwrite: true
  file_glob: true
  file: build/*
  api_key:
    secure: mVOwSNIG/LXshCZD4YzVKLKelp0qqSOzvHME+4huKHqDces3CSUIPLThvxk1/Uk3foKn1IiIcAsZaQ+LGieGCqi204nDDsjuLxuqSqoO5P9Q+Hqs81pfHV8hSMKcEGmpmzmTQt+RDBuSXyoGx8YC3d65JKyOEpgbpzScnWo79LLEYXopUnq5p2jKG15AoVWQTDbm9OnoItfic1iFwEG2KlHLEx4MOhHtn79Yhuxkya9O452s7xJu2EoC7VsN0u66bhp+NQ8/J2qCDNATRfUMCT5FMBLdK6DX0aoD3wxdXkiVYUUoev3Qw0WaqYwZwDos/1T2ttn+PGEkYe6jTKlMyiH2J9jeWjaRdV0dIKVdxMyS0cJpf6n32Lb3HQ+g9RcEXeywC4ZV5SXHfYTv3WlJcAmKmCktPS9ErQ3FmttcKT6xO1C7S2IQViXE1Q/Ml7go9+hUzMNvJLxfW2O1TjmeS/uspK5a5Ln+/f4qQx70h87Cf25kNsFrLPxakgcV/I+giMALa2ilWODhbpGRC/PdO3M/LUxVtenz0jgczq//S9uvMLHt0qDP5IXVVQIUJ6tzT+UAyOCEh4HRYP5wIRpHwqA4xyWcAvgRXIGT1K/fLDuxl2VENmVY9H1H7Keh3kKdf77nA+T/6bIiig7+0jt9LVDKrTqKektGLghaahOQSTM=
  on:
    tags: true